<!DOCTYPE html>
<meta charset="utf-8">
<title>Gêneros de animes por mês</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
<style>
html, body {
  background: #fff;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

.container {
  position: absolute;
  top: 0;
  left: 0;
  right: .1em;
  bottom: .5em;
  margin: 0;
  padding: 0;
}
/* Fix popup flickering */
.container svg > g:last-of-type {
  pointer-events: none;
}
</style>

<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.4.2/tabletop.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.1.2/tinycolor.min.js"></script>
<div id="container" class="container">Carregando...</div>

<script>
google.charts.load('current', {'packages': ['corechart']})
google.charts.setOnLoadCallback(function () {
  Tabletop.init({
    key: '1kW8dzToIjyumRM5US4o2dHB8mwBhuOw81KPKGMy6YZE',
    callback: fetchCallback
  })
})

function fetchCallback (sheets, tabletop) {
  var container = document.getElementById('container')
  var keys = {
    assistido: 'Assistido',
    animes: 'Animes',
    nome: 'Nome',
    data: 'Data',
    episodio: 'Episódio',
    duracao: 'Duração',
    generos: 'Gêneros'
  }

  var animeInfo = sheets[keys.animes].elements
  var animeNames = animeInfo.map(function (e) {
    return e[keys.nome]
  })

  var invervalDataObj = sheets[keys.assistido].elements.reduce(function (acc, e) {
    var date = new Date(e[keys.data])
    var name = e[keys.nome]

    date.setDate(0)
    date.setHours(0)
    date.setMinutes(0)
    date.setSeconds(0)
    date.setMilliseconds(0)
    var day = Math.floor(date.valueOf())

    var index = animeNames.indexOf(name)
    if (index === -1) {
      console.log("%s episode score isn't defined, ignoring.", name)
      return acc
    }

    var info = animeInfo[index]
    var genres = info[keys.generos]
    if (!genres) return acc

    if (!acc[day]) acc[day] = {}
    genres.split(/\s*,\s*/g).forEach(function (genre) {
      acc[day][genre] = (acc[day][genre] || 0) + 1
    })

    return acc
  }, {})

  var genreList = 'Action|Adventure|Comedy|Dementia|Demons|Drama|Ecchi|Fantasy|Game|Harem|Historical|Horror|Josei|Kids|Magic|Martial Arts|Mecha|Military|Music|Mystery|Parody|Police|Psychological|Romance|Samurai|School|Sci-Fi|Seinen|Shoujo|Shoujo Ai|Shounen|Slice of Life|Space|Sports|Super Power|Supernatural|Thriller|Vampire|Yuri'.split('|')
  function getGenreColor (genre) {
    var index = genreList.indexOf(genre)
    if (index === -1) return 'gray'
    return tinycolor(index > 20 ? '#D22' : '#F11').spin(index * 108).toString()
  }

  var genreCount = 7
  var invervalKeys = Object.keys(invervalDataObj)
  var invervalData = invervalKeys.map(function (e, i) {
    var date = new Date(+e)
    var genres = invervalDataObj[e]
    var row = [date]

    var genreNames = Object.keys(genres)
    if (genreNames.length < genreCount + 1) return null

    genreNames.sort(function (a, b) {
      return genres[b] - genres[a]
    })

    var total = genreNames.reduce(function (sum, genre) {
      return sum + genres[genre]
    }, 0)

    var formattedDate = date.toLocaleDateString()
    function formatText (category, value) {
      return '<i>' + formattedDate + '</i><br><b>' + category + '</b><br>' +
        value + ' episodes'
    }

    var otherValue = genreNames.slice(genreCount).reduce(function (sum, genre) {
      return sum + genres[genre]
    }, 0)
    row = row.concat([
      otherValue / total,
      formatText('Other genres', otherValue),
      'gray'
    ])

    genreNames.slice(0, genreCount).reverse().forEach(function (genre, index) {
      row = row.concat([
        genres[genre] / total,
        formatText(genre, genres[genre]),
        getGenreColor(genre)
      ])
    })

    return row
  }).filter(function (e) {
    return e
  }).slice(2)

  var data = new google.visualization.DataTable()
  data.addColumn('date', 'Mês')
  for (var i = 0; i < genreCount + 1; i++) {
    data.addColumn('number', '% do gênero')
    data.addColumn({ type: 'string', role: 'tooltip', p: {html: true} })
    data.addColumn({ type: 'string', role: 'style' })
  }
  data.addRows(invervalData)

  var options = {
    title: 'Gêneros por mês',
    legend: 'none',
    isStacked: 'percent',
    tooltip: {isHtml: true},
    chartArea: {
      left: '3%',
      top: '5%',
      width: '97%',
      height: '90%'
    }
  }

  var chart = new google.visualization.ColumnChart(container)
  var nextRender
  var renderTimer = null
  window.addEventListener('resize', function () {
    clearTimeout(renderTimer)
    renderTimer = setTimeout(doDraw, nextRender - Date.now())
  })
  doDraw()

  function doDraw () {
    nextRender = Date.now() + 1e3
    chart.draw(data, options)
  }
}
</script>
